## Deployment Documentation for Backend

## Table of Contents
1. Introduction
2. Deployment Environments
3. Local Development Setup
4. Containerization
5. Continuous Integration
6. Continuous Deployment
7. Database Migrations
8. Infrastructure Provisioning
9. Environment Configuration
10. Monitoring and Logging
11. Scaling and Performance
12. Rollback Procedures
13. Security Considerations
14. Troubleshooting
15. References

## 1. Introduction

This document provides a comprehensive guide to deploying the backend component of the Interaction Management System. It covers various aspects of the deployment process, including environment setup, containerization, CI/CD pipelines, database migrations, infrastructure provisioning, and production deployment strategies.

## 2. Deployment Environments

The Interaction Management System supports the following deployment environments:

- **Development:** Used by developers for local development and testing.
- **Staging:** Used for integration testing and pre-production validation.
- **Production:** The live environment serving end-users.

Each environment has specific configuration requirements and deployment procedures.

### 2.1 Environment Configuration Summary

| Environment   | Purpose                                  | Configuration Source                                  | Data Source                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
### 3.3 DATABASES & STORAGE

| Component | Technology | Version | Justification |
|-----------|------------|---------|---------------|
| Primary Database | PostgreSQL | 15.3 | Relational database providing robust support for complex queries needed for the searchable Finder, with excellent data integrity features |
| Database Migrations | Alembic | 1.11.1 | Tracks and manages database schema changes during development and deployment |
| Connection Pooling | PgBouncer | 1.19.0 | Optimizes database connections for improved performance under concurrent user load |
| Caching Layer | Redis | 7.0.12 | Provides in-memory caching for frequently accessed data like user sessions and common searches |

PostgreSQL was selected over MongoDB (from the default stack) because:
- The Interaction entity has a well-defined structure that benefits from a schema
- The search requirements suggest complex queries across multiple fields
- The site-scoping feature benefits from relational integrity constraints

### 3.4 THIRD-PARTY SERVICES

| Service | Purpose | Justification |
|---------|---------|---------------|
| Auth0 | Authentication provider | Provides secure, scalable authentication with support for various login methods and session management |
| AWS S3 | Static asset storage | Hosts frontend assets with high availability and global distribution |
| AWS CloudWatch | Logging and monitoring | Centralized logging for application events and performance metrics |
| SendGrid | Email notifications | Handles transactional emails for account management and notifications |

### 3.5 DEVELOPMENT & DEPLOYMENT

| Component | Technology | Version | Justification |
|-----------|------------|---------|---------------|
| Version Control | Git/GitHub | - | Industry standard for source control with excellent collaboration features |
| CI/CD | GitHub Actions | - | Automates testing and deployment workflows integrated with the version control system |
| Containerization | Docker | 24.0.5 | Ensures consistent environments across development and production |
| Infrastructure as Code | Terraform | 1.5.4 | Manages cloud infrastructure with version-controlled configuration |
| API Documentation | Swagger/OpenAPI | 3.0 | Self-documenting API specifications for developer reference |
| Code Quality | ESLint, Pylint | 8.46.0, 2.17.5 | Enforces code style and identifies potential issues early |

## 7. SYSTEM COMPONENTS DESIGN

### 7.2 BACKEND COMPONENTS

#### 6.2.3 Data Access Layer

| Component | Responsibility | Implementation Details |
|-----------|----------------|------------------------|
| Models | Data structure definitions | SQLAlchemy ORM models |
| Repositories | Database access abstraction | Class-based repositories with CRUD operations |
| Query Builders | Complex query construction | Helper classes for search/filter queries |
| Migrations | Schema version management | Alembic migration scripts |
| Connection Manager | Database connectivity | Connection pool management via PgBouncer |

### 6.3 DATA MODELS

#### 6.3.3 Schema Design

**PostgreSQL Schema:**

```
-- Users table
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(256) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);

-- Sites table
CREATE TABLE sites (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- User-Site association table
CREATE TABLE user_sites (
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    site_id INTEGER REFERENCES sites(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    PRIMARY KEY (user_id, site_id),
    CONSTRAINT valid_role CHECK (role IN ('admin', 'user', 'viewer'))
);

-- Interactions table
CREATE TABLE interactions (
    id SERIAL PRIMARY KEY,
    site_id INTEGER NOT NULL REFERENCES sites(id) ON DELETE CASCADE,
    title VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    lead VARCHAR(100) NOT NULL,
    start_datetime TIMESTAMP NOT NULL,
    end_datetime TIMESTAMP NOT NULL,
    timezone VARCHAR(50) NOT NULL,
    location VARCHAR(200),
    description TEXT NOT NULL,
    notes TEXT,
    created_by INTEGER NOT NULL REFERENCES users(id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT valid_dates CHECK (end_datetime > start_datetime)
);

-- Interaction history table
CREATE TABLE interaction_history (
    id SERIAL PRIMARY KEY,
    interaction_id INTEGER NOT NULL REFERENCES interactions(id) ON DELETE CASCADE,
    changed_by INTEGER NOT NULL REFERENCES users(id),
    changed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    change_type VARCHAR(20) NOT NULL,
    before_state JSONB,
    after_state JSONB
);

-- Indexes
CREATE INDEX idx_interactions_site ON interactions(site_id);
CREATE INDEX idx_interactions_site_type ON interactions(site_id, type);
CREATE INDEX idx_interactions_site_date ON interactions(site_id, start_datetime);
CREATE INDEX idx_interaction_history_interaction ON interaction_history(interaction_id);
CREATE INDEX idx_user_sites_site ON user_sites(site_id);
CREATE INDEX idx_user_sites_user ON user_sites(user_id);

-- Full-text search
CREATE INDEX idx_interactions_fts ON interactions 
USING gin(to_tsvector('english', title || ' ' || description || ' ' || COALESCE(notes, '')));
```

**Migration Strategy:**

- Initial schema creation with Alembic
- Separate migrations for each logical schema change
- Forward and backward migration support
- Site-aware data migrations when schema changes affect existing data
- Testing of migrations in staging environment before production deployment

## 8. INFRASTRUCTURE

### 8.3 CONTAINERIZATION

#### 8.3.2 Base Image Strategy

| Component | Base Image | Justification |
|-----------|------------|---------------|
| Frontend | node:19-alpine | Lightweight, includes Node.js for Angular build |
| Backend | python:3.11-slim | Minimal image with required Python version |
| Database | N/A (Using AWS RDS) | Managed service preferred for database |
| Cache | N/A (Using ElastiCache) | Managed service preferred for Redis |

## 9. Environment Configuration

### 9.1 Environment Variables

The backend application relies on environment variables for configuration. These variables are set differently depending on the environment.

| Variable Name | Description | Development | Staging | Production |
|---------------|-------------|-------------|---------|------------|
| FLASK_ENV | Flask environment | development | staging | production |
| DATABASE_URL | Database connection string | (Local SQLite or PostgreSQL) | (Staging PostgreSQL) | (Production PostgreSQL) |
| REDIS_URL | Redis connection string | (Local Redis) | (Staging Redis) | (Production Redis) |
| AUTH0_DOMAIN | Auth0 domain | (Auth0 Development Tenant) | (Auth0 Staging Tenant) | (Auth0 Production Tenant) |
| AUTH0_API_AUDIENCE | Auth0 API audience | (Auth0 Development API) | (Auth0 Staging API) | (Auth0 Production API) |
| SECRET_KEY | Flask secret key | (Development Secret) | (Staging Secret) | (Production Secret) |
| CORS_ORIGINS | Allowed CORS origins | http://localhost:4200 | https://staging.example.com | https://example.com |

### 9.2 Configuration Files

The application uses configuration files for settings that are not environment-specific. These files are version-controlled and deployed with the application.

- `src/backend/config.py`: Contains Python configuration settings for Flask, SQLAlchemy, JWT, and other components.
- `src/backend/gunicorn.conf.py`: Configures the Gunicorn WSGI server for production deployment.
- `src/web/nginx.conf`: Configures the Nginx web server for serving the Angular frontend.

## 4. Containerization

The backend application is containerized using Docker. The `Dockerfile` in the `src/backend` directory defines the steps to build the Docker image.

### 4.1 Dockerfile

The `Dockerfile` uses a [multi-stage build process](#Docker configuration) to reduce the final image size.

1.  **Builder Stage:** Installs dependencies and builds the application.
2.  **Final Stage:** Creates the production image with only the necessary components.

### 4.2 Docker Compose

For local development, Docker Compose is used to orchestrate the backend, frontend, database, and cache services. The `docker-compose.yml` file defines the services and their dependencies.

## 5. Continuous Integration

Continuous Integration (CI) is implemented using GitHub Actions. The `.github/workflows/backend-ci.yml` file defines the CI workflow.

### 5.1 CI Workflow Steps

1.  **Linting:** Checks the code for style and syntax errors using Pylint and Flake8.
2.  **Unit Tests:** Runs unit tests using pytest.
3.  **Integration Tests:** Runs integration tests using pytest and Docker Compose.
4.  **Security Scanning:** Scans the Docker image for vulnerabilities using Trivy.

## 6. Continuous Deployment

Continuous Deployment (CD) is implemented using GitHub Actions. The `.github/workflows/backend-cd-prod.yml` file defines the CD workflow for production deployments.

### 6.1 CD Workflow Steps

1.  **Build and Push Docker Image:** Builds the Docker image and pushes it to Amazon ECR.
2.  **Prepare Database Backup:** Creates a full backup of the production database.
3.  **Manual Approval Gate:** Requires manual approval from authorized personnel before proceeding.
4.  **Execute Database Migrations:** Executes database migrations using Alembic.
5.  **Deploy Blue Environment:** Deploys the new version of the application to a blue environment.
6.  **Run Production Validation:** Runs automated tests to validate the deployment.
7.  **Final Approval Gate:** Requires final approval from authorized personnel before switching traffic.
8.  **Switch Traffic:** Gradually shifts traffic from the green environment to the blue environment.
9.  **Cleanup Green Environment:** Decommissions the old green environment.

### 6.2 Deployment Pipeline

The CD pipeline follows a blue/green deployment strategy to minimize downtime.

## 7. Database Migrations

Database migrations are managed using Alembic. The migration scripts are located in the `src/backend/migrations` directory.

### 7.1 Running Migrations

To run database migrations, use the `src/backend/scripts/run_migrations.py` script.

```bash
python src/backend/scripts/run_migrations.py --revision head
```

### 7.2 Alembic Configuration

The Alembic configuration is stored in the `src/backend/alembic.ini` file.

## 8. Infrastructure Provisioning

Infrastructure provisioning is managed using Terraform. The Terraform configuration files are located in the `infrastructure/terraform` directory.

### 8.1 Terraform Modules

The Terraform configuration is organized into modules for reusability and maintainability.

-   **Networking:** Creates the VPC, subnets, and network security components.
-   **Security:** Creates IAM roles, policies, KMS keys, and security groups.
-   **Database:** Creates the PostgreSQL RDS instance and Redis ElastiCache.
-   **Compute:** Creates the EC2/ECS infrastructure, load balancers, and services.
-   **Monitoring:** Creates CloudWatch dashboards, alarms, and logs.

### 8.2 Provisioning Steps

1.  Configure AWS credentials.
2.  Initialize the Terraform workspace.
3.  Run `terraform plan` to verify changes.
4.  Apply the infrastructure changes with `terraform apply`.

## 10. Monitoring and Logging

Monitoring and logging are implemented using AWS CloudWatch.

### 10.1 CloudWatch Metrics

The following metrics are monitored:

-   CPU utilization
-   Memory usage
-   Disk I/O
-   Network traffic
-   API response time
-   Error rate

### 10.2 CloudWatch Logs

Application logs are sent to CloudWatch Logs for centralized logging and analysis.

## 12. Rollback Procedures

In case of a failed deployment, the following rollback procedures are implemented:

1.  Identify the failure point in the deployment process.
2.  If the database migration failed, restore from the pre-deployment backup.
3.  If the blue environment deployment failed, terminate the new tasks.
4.  If the traffic switch failed or issues are detected, revert to the green environment.
5.  Update the load balancer to route traffic back to the green environment.
6.  Verify that the green environment is serving traffic correctly.
7.  Generate an incident report with detailed diagnostics.
8.  Send a failure notification to the operations team and stakeholders.
9.  Update the production status to indicate a rollback.
10. Schedule a post-mortem analysis meeting.

## 13. Security Considerations

The following security measures are implemented:

-   HTTPS for all communication.
-   IAM roles and policies for access control.
-   Security groups for network isolation.
-   Encryption at rest and in transit.
-   Regular security audits.

## 14. Troubleshooting

This section provides troubleshooting tips for common deployment issues.

-   **Database connection errors:** Verify the database connection string and credentials.
-   **Application startup failures:** Check the application logs for errors.
-   **Load balancer issues:** Verify that the target groups are healthy and that the load balancer is routing traffic correctly.
-   **Migration failures:** Review the migration scripts and ensure that they are compatible with the database schema.

## 15. References

-   [Flask Documentation](https://flask.palletsprojects.com/)
-   [SQLAlchemy Documentation](https://www.sqlalchemy.org/)
-   [Alembic Documentation](https://alembic.sqlalchemy.org/en/latest/)
-   [Terraform Documentation](https://www.terraform.io/docs/)
-   [AWS Documentation](https://docs.aws.amazon.com/)